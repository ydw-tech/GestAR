<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LSA64 — App completa (Multiusuario + Cámara)</title>
  <!-- Tailwind CDN for quick modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM + Babel for JSX in the browser (dev) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- TensorFlow Handpose (fallback de detección de manos) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.8.0/dist/tf-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.8.0/dist/tf-backend-webgl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>

  <style>
    html,body,#root { height: 100%; }
    .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(6px);} 
    canvas.overlay { position: absolute; left:0; top:0; pointer-events:none; }
  </style>
</head>
<body class="bg-gradient-to-r from-sky-400 via-indigo-500 to-purple-600 text-gray-900">
  <div id="root" class="h-full"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  // -------------------- Utilities: PBKDF2 hashing --------------------
  async function genSalt() {
    const buf = crypto.getRandomValues(new Uint8Array(16));
    return Array.from(buf).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function hashPassword(password, saltHex) {
    const enc = new TextEncoder();
    const pw = enc.encode(password);
    const salt = new Uint8Array(saltHex.match(/.{1,2}/g).map(h=>parseInt(h,16)));
    const key = await crypto.subtle.importKey('raw', pw, {name:'PBKDF2'}, false, ['deriveBits']);
    const derived = await crypto.subtle.deriveBits({name:'PBKDF2', salt, iterations: 250000, hash:'SHA-256'}, key, 256);
    const hash = new Uint8Array(derived);
    return Array.from(hash).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // -------------------- LocalStorage users API --------------------
  const STORAGE_KEY = 'lsa_users_v2';
  function loadAllUsers() { try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : {}; } catch(e){return {};}}
  function saveAllUsers(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

  async function createUser(username, password) {
    const all = loadAllUsers();
    if (!username || username.trim().length < 3) throw new Error('Usuario debe tener al menos 3 caracteres');
    if (all[username]) throw new Error('Usuario ya existe');
    const salt = await genSalt();
    const hash = await hashPassword(password, salt);
    const profile = { username, salt, hash, data: { xp:0, streak:0, rewards:[], lastLogin:null } };
    all[username] = profile; saveAllUsers(all); return profile;
  }

  async function verifyLogin(username, password) {
    const all = loadAllUsers(); const profile = all[username];
    if (!profile) throw new Error('Usuario no encontrado');
    const candidate = await hashPassword(password, profile.salt);
    if (candidate !== profile.hash) throw new Error('Contraseña incorrecta');
    profile.data.lastLogin = new Date().toISOString(); saveAllUsers(all); return profile;
  }

  function saveUserData(username, data){ const all = loadAllUsers(); if (!all[username]) return false; all[username].data = data; saveAllUsers(all); return true; }
  function deleteUser(username){ const all = loadAllUsers(); delete all[username]; saveAllUsers(all); }

  // -------------------- Small embedded vocab JSON --------------------
  const VOCAB = {
    Letras: ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","Ñ","O","P","Q","R","S","T","U","V","W","X","Y","Z"],
    Familia: ["madre","padre","hermano","hermana","hijo","hija","esposo","esposa","bebé","abuelo","abuela","tío","tía","primo","prima"],
    "Comidas y Bebidas": ["pan","milanesa","pizza","empanada","manzana","agua","café","leche","asado","ensalada"],
    Trabajos: ["doctor","maestro","cocinero","abogado","ingeniero","programador","bombero","policía"],
    Animales: ["perro","gato","pajaro","vaca","caballo","conejo","tigre"],
    Emociones: ["feliz","triste","enojo","sorpresa","miedo"],
    "Frases Diarias": ["hola","gracias","por favor","lo siento","adios"]
  };

  // -------------------- Main App --------------------
  function App(){
    const [stage, setStage] = useState('auth'); // auth | app | learning
    const [user, setUser] = useState(null);
    const [usersList, setUsersList] = useState(Object.keys(loadAllUsers()));
    const [message, setMessage] = useState('');

    useEffect(()=>{ setUsersList(Object.keys(loadAllUsers())); }, []);

    function onLogout(){ setUser(null); setStage('auth'); }

    async function onCreateAndLogin(username, password){ try{ const profile = await createUser(username, password); setUsersList(Object.keys(loadAllUsers())); setUser(profile); setStage('app'); } catch(e){ setMessage(e.message);} }
    async function onLogin(username, password){ try{ const profile = await verifyLogin(username,password); setUser(profile); setStage('app'); setUsersList(Object.keys(loadAllUsers())); } catch(e){ setMessage(e.message);} }

    function onDeleteUser(username){ if (!confirm('Borrar usuario "' + username + '"? Esto eliminará todo su progreso.')) return; deleteUser(username); setUsersList(Object.keys(loadAllUsers())); if (user && user.username===username) onLogout(); }

    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <div className="w-full max-w-6xl glass rounded-3xl shadow-2xl p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="col-span-1">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl font-bold">LS</div>
              <div>
                <h2 className="text-xl font-semibold">LSA64 — App completa</h2>
                <p className="text-sm text-gray-700">Multiusuario local • Demo</p>
              </div>
            </div>

            {stage==='auth' && (
              <AuthPanel onLogin={onLogin} onCreate={onCreateAndLogin} users={usersList} onDelete={onDeleteUser} message={message} setMessage={setMessage} />
            )}

            {stage==='app' && user && (
              <div>
                <div className="flex justify-between items-center">
                  <div>
                    <div className="text-sm text-gray-700">Conectado como</div>
                    <div className="font-semibold text-lg">{user.username}</div>
                  </div>
                  <div>
                    <button className="px-3 py-1 rounded bg-red-500 text-white" onClick={onLogout}>Cerrar sesión</button>
                  </div>
                </div>

                <div className="mt-4 space-y-3">
                  <div>XP: <strong>{user.data.xp}</strong></div>
                  <div>Streak: <strong>{user.data.streak}</strong></div>
                  <div>Recompensas: <strong>{user.data.rewards.join(', ') || '—'}</strong></div>
                </div>

                <div className="mt-4">
                  <button className="px-3 py-2 rounded bg-indigo-600 text-white" onClick={()=>setStage('learning')}>Ir a lecciones</button>
                </div>

              </div>
            )}

            {stage==='learning' && user && (
              <div>
                <div className="flex justify-between items-center mb-3">
                  <h3 className="font-semibold">Panel</h3>
                  <div className="flex gap-2">
                    <button className="px-2 py-1 rounded border" onClick={()=>{ saveUserData(user.username, user.data); setMessage('Progreso guardado.'); }}>Guardar</button>
                    <button className="px-2 py-1 rounded border" onClick={()=>{ setStage('app'); }}>Volver</button>
                  </div>
                </div>
                <LessonArea user={user} onUpdate={(data)=>{ setUser(prev=>({...prev, data})); saveUserData(user.username, data); }} />
              </div>
            )}

          </div>

          <div className="col-span-2">
            <div className="h-full p-4 bg-gradient-to-br from-white to-gray-100 rounded-2xl">
              <h3 className="text-lg font-semibold mb-2">Cómo abrir la app después</h3>
              <p className="text-sm text-gray-700">Resumen rápido:</p>
              <ol className="list-decimal list-inside text-sm text-gray-700 mt-2 space-y-1">
                <li>Guardar este archivo como <strong>lsa64-app-full.html</strong>.</li>
                <li>Servirlo vía <strong>localhost</strong> o HTTPS (ej.: <code>npx http-server -c-1</code> en la carpeta del archivo).</li>
                <li>Abrir <code>http://localhost:8080/lsa64-app-full.html</code> (o la URL que muestre tu servidor).</li>
                <li>Crear usuario (mínimo 6 caracteres en la contraseña y confirmarla) y entrar.</li>
              </ol>

              <div className="mt-4 p-3 bg-white rounded shadow">
                <h4 className="font-medium">Notas</h4>
                <ul className="list-disc list-inside text-sm text-gray-700 mt-2">
                  <li>localStorage guarda los usuarios en este navegador/computadora. No se sincroniza entre dispositivos.</li>
                  <li>Las contraseñas se guardan como hash PBKDF2 con salt (protección básica para demos locales).</li>
                  <li>Si querés sincronizar entre dispositivos, puedo integrar Firebase/Supabase (te preparo la configuración).</li>
                </ul>
              </div>

            </div>
          </div>
        </div>

      </div>
    );
  }

  // -------------------- AuthPanel with password validation --------------------
  function AuthPanel({ onLogin, onCreate, users, onDelete, message, setMessage }){
    const [mode, setMode] = useState('login'); // login | register
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [confirm, setConfirm] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(()=>{ if (message) setTimeout(()=>setMessage(''),3500); }, [message]);

    async function handleCreate(){
      setLoading(true);
      try{
        // validation
        if (!username || username.trim().length < 3) throw new Error('Usuario debe tener al menos 3 caracteres');
        if (!password || password.length < 6) throw new Error('Contraseña debe tener al menos 6 caracteres');
        if (password !== confirm) throw new Error('La confirmación de contraseña no coincide');
        await onCreate(username, password);
      }catch(e){ setMessage(e.message); }
      setLoading(false);
    }

    async function handleLogin(){
      setLoading(true);
      try{ await onLogin(username, password); }catch(e){ setMessage(e.message); }
      setLoading(false);
    }

    return (
      <div>
        <div className="mb-2 flex gap-2">
          <button className={`px-3 py-1 rounded ${mode==='login'? 'bg-indigo-600 text-white':'border'}`} onClick={()=>setMode('login')}>Login</button>
          <button className={`px-3 py-1 rounded ${mode==='register'? 'bg-indigo-600 text-white':'border'}`} onClick={()=>setMode('register')}>Registro</button>
        </div>

        <div className="space-y-2">
          <input className="w-full p-2 border rounded" placeholder="Usuario (min 3 caracteres)" value={username} onChange={e=>setUsername(e.target.value)} />
          <input className="w-full p-2 border rounded" placeholder="Contraseña (min 6 caracteres)" value={password} onChange={e=>setPassword(e.target.value)} type="password" />
          {mode==='register' && (
            <input className="w-full p-2 border rounded" placeholder="Confirmar contraseña" value={confirm} onChange={e=>setConfirm(e.target.value)} type="password" />
          )}

          {mode==='login' ? (
            <button className="w-full px-3 py-2 bg-green-600 text-white rounded" onClick={handleLogin} disabled={loading}>Entrar</button>
          ) : (
            <button className="w-full px-3 py-2 bg-blue-600 text-white rounded" onClick={handleCreate} disabled={loading}>Crear cuenta</button>
          )}
        </div>

        <div className="mt-4">
          <div className="text-sm font-medium">Usuarios guardados</div>
          <ul className="mt-2 space-y-1">
            {users.length===0 && <li className="text-sm text-gray-600">Ninguno aún</li>}
            {users.map(u=> (
              <li key={u} className="flex justify-between items-center p-2 bg-white rounded">
                <div>{u}</div>
                <div className="flex gap-2">
                  <button className="px-2 py-1 border rounded" onClick={()=>{ const pwd = prompt('Contraseña para ' + u); if (pwd) onLogin(u,pwd); }}>Login</button>
                  <button className="px-2 py-1 border rounded text-red-600" onClick={()=>onDelete(u)}>Borrar</button>
                </div>
              </li>
            ))}
          </ul>
        </div>

        {message && <div className="mt-3 text-sm text-red-600">{message}</div>}
      </div>
    );
  }

  // -------------------- LessonArea (camera + hand detection) --------------------
  function LessonArea({ user, onUpdate }){
    const videoRef = useRef(null);
    const overlayRef = useRef(null);
    const [category, setCategory] = useState(Object.keys(VOCAB)[0]);
    const [queue, setQueue] = useState(VOCAB[Object.keys(VOCAB)[0]].slice());
    const [prompt, setPrompt] = useState(queue[0]);
    const [cameraOn, setCameraOn] = useState(false);
    const [handModel, setHandModel] = useState(null);
    const [handsDetected, setHandsDetected] = useState(false);
    const intervalRef = useRef(null);

    useEffect(()=>{ setQueue(VOCAB[category].slice()); setPrompt(VOCAB[category][0]); }, [category]);

    useEffect(()=>{ async function loadHand(){ try{ const m = await handpose.load(); setHandModel(m); }catch(e){ console.warn(e);} } loadHand(); },[]);

    async function startCamera(){
      try{
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
        videoRef.current.srcObject = s; await videoRef.current.play(); setCameraOn(true);
        intervalRef.current = setInterval(captureAndDetect, 250);
      }catch(e){ alert('Error abriendo cámara: ' + e.message); }
    }
    function stopCamera(){ clearInterval(intervalRef.current); const s = videoRef.current?.srcObject; if (s) s.getTracks().forEach(t=>t.stop()); if (videoRef.current) videoRef.current.srcObject = null; setCameraOn(false); const ctx = overlayRef.current?.getContext('2d'); if (ctx) ctx.clearRect(0,0,overlayRef.current.width, overlayRef.current.height); }

    async function captureAndDetect(){
      if (!videoRef.current || !handModel) return;
      const video = videoRef.current;
      const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight; const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0);
      const preds = await handModel.estimateHands(canvas);
      const overlay = overlayRef.current; overlay.width = canvas.width; overlay.height = canvas.height; const octx = overlay.getContext('2d'); octx.clearRect(0,0,overlay.width, overlay.height);
      if (preds && preds.length>0){ preds.forEach(p => { const tl = p.boundingBox.topLeft; const br = p.boundingBox.bottomRight; const x = tl[0], y=tl[1], w=br[0]-tl[0], h=br[1]-tl[1]; octx.strokeStyle = 'rgba(0,200,150,0.95)'; octx.lineWidth = 3; octx.strokeRect(x,y,w,h); }); setHandsDetected(true);} else { setHandsDetected(false); }
    }

    function markPassed(){ const data = {...user.data}; data.xp = (data.xp || 0) + 15; data.streak = (data.streak || 0) + 1; if (data.streak % 5 === 0) { data.rewards = (data.rewards||[]).concat([`Racha ${data.streak}`]); } onUpdate(data); const rem = queue.slice(1); setQueue(rem); setPrompt(rem[0]||null); saveUserData(user.username, data); }

    return (
      <div>
        <div className="flex gap-3 items-center">
          <select className="p-2 border rounded" value={category} onChange={(e)=>setCategory(e.target.value)}>
            {Object.keys(VOCAB).map(k=> <option key={k} value={k}>{k}</option>)}
          </select>
          <button className="px-3 py-1 rounded border" onClick={()=> cameraOn ? stopCamera() : startCamera()}>{cameraOn ? 'Detener cámara' : 'Activar cámara'}</button>
          <div className="ml-auto">Manos detectadas: <strong>{handsDetected ? 'Sí' : 'No'}</strong></div>
        </div>

        <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="relative bg-black rounded overflow-hidden">
            <video ref={videoRef} className="w-full h-64 object-cover" playsInline muted />
            <canvas ref={overlayRef} className="overlay" />
          </div>

          <div className="bg-white p-4 rounded">
            <div className="text-sm text-gray-600">Prompt actual</div>
            <h2 className="text-2xl font-bold mt-1">{prompt || '¡Terminaste esta lección!'}</h2>
            <p className="text-sm mt-2">Realizá la seña frente a la cámara. Si el sistema detecta tu mano y estás conforme, presioná <strong>Marcar como correcto</strong> para registrar progreso.</p>

            <div className="mt-4 flex gap-2">
              <button className="px-3 py-2 bg-green-600 text-white rounded" onClick={markPassed} disabled={!prompt}>Marcar como correcto</button>
              <button className="px-3 py-2 border rounded" onClick={()=>{ const rem = queue.slice(1); setQueue(rem); setPrompt(rem[0]||null);}}>Siguiente</button>
            </div>

            <div className="mt-4 text-sm text-gray-600">
              <div>XP: <strong>{user.data.xp}</strong></div>
              <div>Streak: <strong>{user.data.streak}</strong></div>
              <div>Recompensas: <strong>{user.data.rewards.join(', ') || '—'}</strong></div>
            </div>
          </div>
        </div>

      </div>
    );
  }

  // -------------------- Render --------------------
  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
