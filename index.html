<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GestAR ‚Äî Aprende LSA</title>

  <!-- Tailwind (CDN) y fuente -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- React + Babel (JSX in-browser) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- MediaPipe Hands + Camera Utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    :root{
      --glass: rgba(255,255,255,0.92);
      --muted: #6b7280;
      --accent-start:#7c3aed; --accent-end:#06b6d4;
      --card-radius:14px;
    }
    html,body,#root{height:100%;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;}
    body{margin:0;background:linear-gradient(135deg,#60a5fa 0%,#7c3aed 60%);padding:20px;}
    .card{background:var(--glass);border-radius:var(--card-radius);box-shadow:0 12px 30px rgba(0,0,0,0.12);}
    .muted{color:var(--muted);}
    .accent-text{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));-webkit-background-clip:text;color:transparent;}
    canvas.overlay{position:absolute;left:0;top:0;pointer-events:none;}
    /* Mobile-first tweaks */
    @media(min-width:1024px){ .lg-grid-cols{ display:grid; grid-template-columns: 320px 1fr; gap:20px; } }
  </style>
</head>
<body>
  <div id="root" class="max-w-6xl mx-auto"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  /************************* CONFIG Y UTILS *************************/
  const REQUIRED_ACCURACY = 0.80;      // threshold for passing a single item test
  const CONFIDENCE_THRESHOLD = 0.45;   // threshold for per-frame acceptance (more permissive)
  const TEST_DURATION_SECONDS = 7;
  const CAPTURE_INTERVAL_MS = 140;
  const SMOOTHING_WINDOW = 6;
  const REFERENCE_SAMPLES = 10;        // more samples when capturing reference
  const STORAGE_KEY = 'gestar_users_v3';
  async function genSalt(){ const b=new Uint8Array(16); crypto.getRandomValues(b); return Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join(''); }
  async function hashPassword(password,saltHex){
    const enc=new TextEncoder(), pw=enc.encode(password);
    const salt=new Uint8Array(saltHex.match(/.{1,2}/g).map(h=>parseInt(h,16)));
    const key=await crypto.subtle.importKey('raw',pw,{name:'PBKDF2'},false,['deriveBits']);
    const derived=await crypto.subtle.deriveBits({name:'PBKDF2', salt, iterations:200000, hash:'SHA-256'}, key, 256);
    const hash=new Uint8Array(derived); return Array.from(hash).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  function loadAllUsers(){ try{const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):{} }catch(e){return{}} }
  function saveAllUsers(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
  async function createUser(username,password){
    const all=loadAllUsers(); if(!username||username.trim().length<3) throw new Error('Usuario m√≠nimo 3 caracteres'); if(all[username]) throw new Error('Usuario ya existe'); if(!password||password.length<6) throw new Error('Contrase√±a m√≠nima 6 caracteres');
    const salt=await genSalt(), hash=await hashPassword(password,salt);
    const profile={username,salt,hash,data:{xp:0,streak:0,badges:[],refs:{},progress:{}}};
    all[username]=profile; saveAllUsers(all); return profile;
  }
  async function verifyLogin(username,password){
    const all=loadAllUsers(); const p=all[username]; if(!p) throw new Error('Usuario no encontrado');
    const cand=await hashPassword(password,p.salt); if(cand!==p.hash) throw new Error('Contrase√±a incorrecta');
    p.data.lastLogin=new Date().toISOString(); saveAllUsers(all); return p;
  }
  function saveUserData(username,data){ const all=loadAllUsers(); if(!all[username]) return false; all[username].data=data; saveAllUsers(all); return true; }

  // embeddings helpers from MediaPipe landmarks
  function landmarksToVector(landmarks){
    if(!landmarks||landmarks.length===0) return null;
    const flat=[];
    landmarks.forEach(p=>{ flat.push(p.x||p[0]); flat.push(p.y||p[1]); flat.push(p.z||p[2]||0); });
    const mean=flat.reduce((s,v)=>s+v,0)/flat.length; const centered=flat.map(v=>v-mean);
    const norm=Math.sqrt(centered.reduce((s,v)=>s+v*v,0))||1; return centered.map(v=>v/norm);
  }
  function cosineSim(a,b){ if(!a||!b||a.length!==b.length) return 0; let dot=0; for(let i=0;i<a.length;i++) dot+=a[i]*b[i]; return dot; }

  /********************* App principal *********************/
  function App(){
    const [stage,setStage] = useState('loading'); // loading | landing | auth | dashboard | lessons | practice
    const [user,setUser] = useState(null);
    const [usersList,setUsersList] = useState(Object.keys(loadAllUsers()));
    const [vocab, setVocab] = useState(null);
    const [message,setMessage] = useState('');

    useEffect(()=>{ // cargar vocabulario.json
      fetch('vocabulario.json').then(r=>r.json()).then(data=>{ setVocab(data); setStage('landing'); }).catch(e=>{ console.error(e); setMessage('No se pudo cargar vocabulario.json'); setStage('landing'); });
      setUsersList(Object.keys(loadAllUsers()));
    },[]);

    async function handleCreate(u,p){
      try{ const prof=await createUser(u,p); setUser(prof); setStage('dashboard'); setUsersList(Object.keys(loadAllUsers())); }
      catch(e){ setMessage(e.message); setTimeout(()=>setMessage(''),3000); }
    }
    async function handleLogin(u,p){
      try{ const prof=await verifyLogin(u,p); setUser(prof); setStage('dashboard'); setUsersList(Object.keys(loadAllUsers())); }
      catch(e){ setMessage(e.message); setTimeout(()=>setMessage(''),3000); }
    }
    function handleLogout(){ setUser(null); setStage('landing'); }

    if(stage==='loading') return (<div className="min-h-screen flex items-center justify-center text-white">Cargando...</div>);

    return (
      <div className="max-w-6xl mx-auto">
        <header className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-4">
            <div className="w-12 h-12 rounded-full" style={{background:'linear-gradient(45deg,var(--accent-start),var(--accent-end))', color:'#fff', display:'flex', alignItems:'center', justifyContent:'center', fontWeight:700}}>G</div>
            <div>
              <div className="text-2xl font-bold text-white">GestAR</div>
              <div className="text-sm text-white/90">Aprend√© Lengua de Se√±as Argentina</div>
            </div>
          </div>
          <div>
            { user ? (
              <div className="flex items-center gap-3 bg-white/90 p-2 rounded">
                <div className="text-sm">Hola, <strong>{user.username}</strong></div>
                <button className="px-3 py-1 rounded bg-red-500 text-white" onClick={()=>{ handleLogout(); }}>Cerrar sesi√≥n</button>
              </div>
            ) : (
              <div className="text-white/90">Inici√° sesi√≥n para guardar tu progreso</div>
            ) }
          </div>
        </header>

        <main className="lg-grid-cols">
          {/* SIDEBAR / auth */}
          <aside className="card p-4">
            { stage==='landing' && (
              <div>
                <h2 className="text-xl font-semibold mb-2">Bienvenida</h2>
                <p className="muted mb-4">Comenz√° con el abecedario y desbloque√° niveles a medida que avanz√°s.</p>
                <div className="flex flex-col gap-2">
                  <button className="px-3 py-2 bg-indigo-600 text-white rounded" onClick={()=>setStage('auth')}>Entrar / Crear cuenta</button>
                  <button className="px-3 py-2 border rounded" onClick={()=>{ setUser({ username:'Invitado', data:{ xp:0, streak:0, badges:[], refs:{}, progress:{} } }); setStage('dashboard'); }}>Entrar como invitado</button>
                </div>
              </div>
            )}

            { stage==='auth' && <AuthPanel onCreate={handleCreate} onLogin={handleLogin} users={usersList} message={message} /> }

            { stage!=='auth' && stage!=='landing' && user && (
              <div>
                <div className="mb-4">
                  <div className="text-sm muted">XP</div>
                  <div className="text-2xl font-bold">{user.data.xp}</div>
                </div>
                <div className="mb-4">
                  <div className="text-sm muted">Streak</div>
                  <div className="text-2xl font-bold">üî• {user.data.streak}</div>
                </div>
                <div>
                  <div className="text-sm muted">Badges</div>
                  <div className="flex gap-2 mt-2 flex-wrap">
                    {(user.data.badges || []).length ? user.data.badges.map((b,i)=><div key={i} className="px-2 py-1 bg-yellow-100 rounded text-sm">{b}</div>) : <div className="text-sm text-gray-500">‚Äî</div>}
                  </div>
                </div>
              </div>
            )}
          </aside>

          {/* MAIN */}
          <section className="card p-5">
            { stage==='dashboard' && vocab && user && (
              <DashboardView vocab={vocab} user={user} onOpenLessons={()=>setStage('lessons')} onOpenPractice={()=>setStage('practice')} onSaveUser={(d)=>{ setUser(prev=>({...prev, data:d})); saveUserData(user.username, d); }} />
            )}

            { stage==='lessons' && vocab && user && (
              <LessonsView vocab={vocab} user={user} onSaveUser={(d)=>{ setUser(prev=>({...prev, data:d})); saveUserData(user.username, d); }} onBack={()=>setStage('dashboard')} />
            )}

            { stage==='practice' && vocab && user && (
              <PracticeView vocab={vocab} user={user} onSaveUser={(d)=>{ setUser(prev=>({...prev, data:d})); saveUserData(user.username, d); }} onBack={()=>setStage('dashboard')} />
            )}
          </section>
        </main>

        <footer className="mt-6 text-sm text-white/90">
          <div className="card p-4">
            <div><strong>INALSA:</strong> Instituto Nacional de Lengua de Se√±as Argentina. Organismo que promueve el uso y la ense√±anza de la LSA; fomenta su difusi√≥n y protecci√≥n como patrimonio ling√º√≠stico y cultural. (P√°gina oficial: <a href="https://www.argentina.gob.ar" target="_blank" rel="noreferrer" className="underline">argentina.gob.ar</a>)</div>
            <div className="mt-2 muted">Consejo: grab√° tus propias fotos/videos de referencia para evitar problemas de derechos y mejorar la precisi√≥n.</div>
          </div>
        </footer>
      </div>
    );
  }

  /***************** COMPONENTES *****************/
  function AuthPanel({ onCreate, onLogin, users, message }){
    const [mode, setMode] = useState('login');
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [confirm, setConfirm] = useState('');
    async function doCreate(){ try{ if(password.length<6) throw new Error('Contrase√±a m√≠nima 6'); if(password!==confirm) throw new Error('Confirmaci√≥n no coincide'); await onCreate(username,password); }catch(e){ alert(e.message); } }
    async function doLogin(){ try{ await onLogin(username,password); }catch(e){ alert(e.message); } }
    return (
      <div>
        <div className="flex gap-2 mb-4">
          <button className={`px-3 py-2 rounded ${mode==='login'?'bg-indigo-600 text-white':'border'}`} onClick={()=>setMode('login')}>Entrar</button>
          <button className={`px-3 py-2 rounded ${mode==='register'?'bg-indigo-600 text-white':'border'}`} onClick={()=>setMode('register')}>Registro</button>
        </div>
        <input className="w-full p-2 border rounded mb-2" placeholder="Usuario" value={username} onChange={e=>setUsername(e.target.value)} />
        <input className="w-full p-2 border rounded mb-2" placeholder="Contrase√±a" type="password" value={password} onChange={e=>setPassword(e.target.value)} />
        { mode==='register' && <input className="w-full p-2 border rounded mb-2" placeholder="Confirmar contrase√±a" type="password" value={confirm} onChange={e=>setConfirm(e.target.value)} /> }
        { mode==='login' ? <button className="w-full px-3 py-2 bg-green-600 text-white rounded" onClick={doLogin}>Entrar</button>
         : <button className="w-full px-3 py-2 bg-blue-600 text-white rounded" onClick={doCreate}>Crear cuenta</button> }
        <div className="mt-4">
          <div className="text-sm mb-2">Usuarios guardados</div>
          <ul className="space-y-2">
            { users.length===0 && <li className="text-sm muted">Ninguno</li> }
            { users.map(u=>(
              <li key={u} className="flex justify-between items-center p-2 bg-white rounded">
                <div>{u}</div>
                <div className="flex gap-2">
                  <button className="px-2 py-1 border" onClick={()=>{ const pwd = prompt('Contrase√±a para '+u); if(pwd) onLogin(u,pwd); }}>Entrar</button>
                </div>
              </li>
            )) }
          </ul>
        </div>
        { message && <div className="mt-3 text-sm text-red-600">{message}</div> }
      </div>
    );
  }

  /********** DashboardView: accordion (niveles) **********/
  function DashboardView({ vocab, user, onOpenLessons, onOpenPractice, onSaveUser }){
    const levels = vocab.levels || [];
    // progress from user.data.progress
    const progress = user.data.progress || {};
    function levelCompleted(levelIndex){
      const lvl = levels[levelIndex];
      if(!lvl) return false;
      // completed if all lessons completed true in user progress
      const pLvl = progress[lvl.name] || {};
      const lessons = lvl.lessons || [];
      return lessons.every((ls,i)=> pLvl[ls.title] && pLvl[ls.title].completed );
    }
    async function tryUnlockNext(levelIndex){
      // if completed, unlock next
      if(levelCompleted(levelIndex)){
        const nxt = levelIndex+1;
        if(levels[nxt] && !levels[nxt].unlocked){
          levels[nxt].unlocked = true;
          // persist as user progress
          const data = {...user.data}; data.progress = data.progress || {};
          data.progress[levels[nxt].name] = data.progress[levels[nxt].name] || {};
          data.progress[levels[nxt].name].unlocked = true;
          onSaveUser(data);
          alert('¬°Has desbloqueado: ' + levels[nxt].name + '!');
        }
      }
    }
    // run tryUnlockNext whenever component shown
    useEffect(()=>{ levels.forEach((l,idx)=> tryUnlockNext(idx-1)); }, []);
    return (
      <div>
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-2xl font-bold">Panel</h2>
          <div className="flex gap-2">
            <button className="px-3 py-2 border rounded" onClick={()=>onOpenLessons()}>Lecciones</button>
            <button className="px-3 py-2 border rounded" onClick={()=>onOpenPractice()}>Pr√°ctica</button>
          </div>
        </div>

        <p className="text-sm muted mb-4">Avanza por niveles. Completa las mini-lecciones (bloques) para desbloquear el siguiente nivel.</p>

        <div className="space-y-3">
          { (levels || []).map((lvl, li) => {
            // determine unlocked via either vocab file flag or user progress
            const p = user.data.progress && user.data.progress[lvl.name];
            const unlocked = (lvl.unlocked === true) || (p && p.unlocked === true);
            const lessons = lvl.lessons || [];
            const completedCount = lessons.filter(ls => (p && p[ls.title] && p[ls.title].completed)).length;
            const total = lessons.length;
            return (
              <div key={lvl.name} className={"card p-3"}>
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-lg font-semibold">{lvl.name} {unlocked ? '' : 'üîí'}</div>
                    <div className="text-sm muted">{completedCount}/{total} lecciones completadas</div>
                  </div>
                  <div className="flex gap-2">
                    <button className="px-3 py-1 border rounded" onClick={() => {
                      if(!unlocked) { alert('Nivel bloqueado. Complet√° el nivel anterior para desbloquearlo.'); return; }
                      // store selected category and go to lessons
                      localStorage.setItem('gestar_selected_level', lvl.name);
                      onOpenLessons();
                    }}>Ver lecciones</button>
                    <button className="px-3 py-1 border rounded" onClick={()=>{
                      if(!unlocked) { alert('Nivel bloqueado.'); return; }
                      localStorage.setItem('gestar_selected_level', lvl.name);
                      onOpenPractice();
                    }}>Practicar</button>
                  </div>
                </div>

                <div className="mt-3">
                  <div className="w-full bg-gray-200 h-2 rounded overflow-hidden">
                    <div style={{width: `${Math.round((completedCount/total)*100)}%`}} className="h-2 bg-gradient-to-r from-indigo-500 to-cyan-400"></div>
                  </div>
                </div>
              </div>
            );
          }) }
        </div>
      </div>
    );
  }

  /*************** LessonsView (captura de referencias y marcar lecciones completadas) ***************/
  function LessonsView({ vocab, user, onSaveUser, onBack }){
    const levels = vocab.levels || [];
    const selectedLevelName = localStorage.getItem('gestar_selected_level') || (levels[0] && levels[0].name);
    const level = levels.find(l=>l.name===selectedLevelName) || levels[0];
    const lessons = level.lessons || [];
    const [lessonIndex, setLessonIndex] = useState(0);
    const p = user.data.progress || {};
    const userLevelProgress = p[level.name] || {};
    useEffect(()=>{ localStorage.setItem('gestar_selected_level', level.name); }, [level]);

    async function markLessonCompleted(idx){
      const lesson = lessons[idx];
      const data = {...user.data}; data.progress = data.progress || {}; data.progress[level.name] = data.progress[level.name] || {};
      data.progress[level.name][lesson.title] = { completed: true, completedAt: new Date().toISOString() };
      // unlock next lesson or next level automatically happens in dashboard when reading progress
      onSaveUser(data);
      alert('¬°Lecci√≥n completada: ' + lesson.title + '!');
    }

    return (
      <div>
        <div className="flex items-center justify-between mb-4">
          <div>
            <h2 className="text-xl font-semibold">Lecciones ‚Äî {level.name}</h2>
            <div className="text-sm muted">Captur√° referencias para cada √≠tem y marc√° la lecci√≥n como completada cuando est√©s listo.</div>
          </div>
          <div className="flex gap-2">
            <select className="p-2 border rounded" value={level.name} onChange={(e)=>{ localStorage.setItem('gestar_selected_level', e.target.value); location.reload(); }}>
              { levels.map(l=> <option key={l.name} value={l.name}>{l.name}</option>) }
            </select>
            <button className="px-3 py-2 border rounded" onClick={onBack}>Volver</button>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="md:col-span-2">
            <div className="p-4 bg-white rounded">
              <div className="text-sm muted">Lecci√≥n</div>
              <div className="text-2xl font-bold my-3">{lessons[lessonIndex].title}</div>
              <div className="text-sm muted">Items:</div>
              <div className="mt-3 grid grid-cols-2 gap-2">
                { lessons[lessonIndex].items.map(it => (
                  <div key={it.id || it} className="p-2 border rounded flex justify-between items-center">
                    <div>
                      <div className="font-medium">{typeof it === 'string' ? it : it.palabra}</div>
                      <div className="text-xs muted">{(typeof it === 'object' && it.instruction) ? it.instruction : ''}</div>
                    </div>
                    <div className="flex flex-col gap-1">
                      <button className="px-2 py-1 text-xs border rounded" onClick={()=>{ localStorage.setItem('gestar_selected_item', (typeof it==='string'?it:it.palabra)); alert('Item seleccionado. Ahora pod√©s ir a Pr√°ctica para capturar o testear.'); }}>Seleccionar</button>
                    </div>
                  </div>
                )) }
              </div>

              <div className="mt-4 flex gap-2">
                <button className="px-3 py-2 bg-indigo-600 text-white rounded" onClick={()=>markLessonCompleted(lessonIndex)}>Marcar lecci√≥n como completada</button>
                <button className="px-3 py-2 border rounded" onClick={()=>setLessonIndex((lessonIndex+1) % lessons.length)}>Siguiente lecci√≥n</button>
              </div>
            </div>
          </div>

          <div className="md:col-span-1">
            <div className="p-3 bg-white rounded">
              <h3 className="font-semibold mb-2">Progreso de la lecci√≥n</h3>
              <ul className="space-y-2">
                { lessons.map((ls,i)=> {
                  const done = (user.data.progress && user.data.progress[level.name] && user.data.progress[level.name][ls.title] && user.data.progress[level.name][ls.title].completed) || false;
                  return (<li key={ls.title} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                    <div>{ls.title}</div>
                    <div>{done ? '‚úîÔ∏è' : '‚Äî'}</div>
                  </li>);
                }) }
              </ul>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /**************** PracticeView: c√°mara + auto test + feedback ****************/
  function PracticeView({ vocab, user, onSaveUser, onBack }){
    const levels = vocab.levels || [];
    const selectedLevelName = localStorage.getItem('gestar_selected_level') || (levels[0] && levels[0].name);
    const level = levels.find(l=>l.name===selectedLevelName) || levels[0];
    const lessonTitle = localStorage.getItem('gestar_selected_lesson') || (level.lessons && level.lessons[0] && level.lessons[0].title);
    const lesson = (level.lessons || []).find(ls=>ls.title===lessonTitle) || (level.lessons && level.lessons[0]) || {};
    const selectedItemName = localStorage.getItem('gestar_selected_item') || (lesson.items && (typeof lesson.items[0] === 'object' ? lesson.items[0].palabra : lesson.items[0]));
    const [queue, setQueue] = useState((lesson.items || []).map(it => (typeof it === 'string' ? it : it.palabra)));
    const [index, setIndex] = useState(Math.max(0, queue.indexOf(selectedItemName)));
    const videoRef = useRef(null);
    const overlayRef = useRef(null);
    const handsRef = useRef(null);
    const cameraRef = useRef(null);
    const lastLandmarksRef = useRef(null);

    const [cameraOn,setCameraOn] = useState(false);
    const [running,setRunning] = useState(false);
    const [frames,setFrames] = useState(0);
    const [correct,setCorrect] = useState(0);
    const [accuracy,setAccuracy] = useState(0);
    const [statusText,setStatusText] = useState('C√°mara inactiva');

    // init hands
    useEffect(()=>{
      const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
      hands.setOptions({ maxNumHands: 2, minDetectionConfidence: 0.25, minTrackingConfidence: 0.25 });
      hands.onResults(onResults);
      handsRef.current = hands;
      return ()=>{};
    },[]);

    function onResults(results){
      drawOverlay(results.multiHandLandmarks);
      lastLandmarksRef.current = (results.multiHandLandmarks && results.multiHandLandmarks[0]) ? results.multiHandLandmarks[0] : null;
      lastLandmarksRef.current && (lastLandmarksRef.current._time = Date.now());
    }

    function drawOverlay(multi){
      const canvas = overlayRef.current, video = videoRef.current;
      if(!canvas || !video) return;
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
      if(multi && multi.length>0){
        multi.forEach(lm=>{
          const xs = lm.map(p=>p.x*canvas.width), ys = lm.map(p=>p.y*canvas.height);
          const minX = Math.min(...xs), maxX=Math.max(...xs), minY=Math.min(...ys), maxY=Math.max(...ys);
          ctx.strokeStyle = 'rgba(34,197,94,0.95)'; ctx.lineWidth=3; ctx.strokeRect(minX,minY,maxX-minX,maxY-minY);
        });
      }
    }

    async function startCamera(){
      try{
        const video = videoRef.current;
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:640, height:480 }, audio:false });
        video.srcObject = stream; await video.play();
        cameraRef.current = new Camera(video, { onFrame: async()=>{ await handsRef.current.send({image:video}); }, width:640, height:480 });
        cameraRef.current.start();
        setCameraOn(true); setStatusText('C√°mara activa. Aline√° la mano con el recuadro.');
      } catch(e){ alert('Error iniciando c√°mara: ' + e.message); }
    }
    function stopCamera(){
      if(cameraRef.current) try{ cameraRef.current.stop(); }catch(e){}
      const v = videoRef.current; if(v && v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
      if(videoRef.current) videoRef.current.srcObject = null;
      setCameraOn(false); setStatusText('C√°mara detenida');
    }

    function getReferenceFor(word){
      const key = level.name + ':' + word;
      return (user.data.refs && user.data.refs[key]) || null;
    }

    function landmarksToVectorOrNull(lm){
      if(!lm) return null;
      return landmarksToVector(lm);
    }

    async function runTestFor(word){
      if(!cameraOn) await startCamera();
      setRunning(true); setFrames(0); setCorrect(0); setAccuracy(0); setStatusText('Test en curso...');
      const endAt = Date.now() + TEST_DURATION_SECONDS*1000;
      let localFrames=0, localCorrect=0;
      while(Date.now() < endAt){
        await new Promise(r=>setTimeout(r, CAPTURE_INTERVAL_MS));
        localFrames++;
        const lm = lastLandmarksRef.current && lastLandmarksRef.current._time && (Date.now() - lastLandmarksRef.current._time < 900) ? lastLandmarksRef.current : null;
        if(!lm){
          setStatusText('Sin manos detectadas ‚Äî acerc√° y centrala.');
          setFrames(localFrames); setCorrect(localCorrect); setAccuracy(localCorrect/localFrames);
          continue;
        }
        const emb = landmarksToVectorOrNull(lm);
        const ref = getReferenceFor(word);
        let score = 0.5; // fallback
        if(ref && ref.embedding){
          score = (cosineSim(emb, ref.embedding) + 1) / 2; // [0,1]
        } else {
          // partial credit if hand present
          score = 0.5;
        }
        // smoothing not necessary here because we evaluate per-frame threshold
        if(score >= CONFIDENCE_THRESHOLD) localCorrect++;
        setFrames(localFrames); setCorrect(localCorrect); setAccuracy(localCorrect/localFrames);
      }
      setRunning(false);
      const finalAcc = (localFrames===0)?0:(localCorrect/localFrames);
      // award xp if pass
      const data = {...user.data};
      if(finalAcc >= REQUIRED_ACCURACY){
        const gain = Math.round(10 + finalAcc*20);
        data.xp = (data.xp||0) + gain;
        data.streak = (data.streak||0) + 1;
        if(data.streak % 7 === 0) data.badges = Array.from(new Set([...(data.badges||[]),'7-day streak']));
        alert(`Resultado: ${(finalAcc*100).toFixed(0)}% ‚Äî APROBADO ‚Äî +${gain} XP`);
      } else {
        data.streak = 0;
        alert(`Resultado: ${(finalAcc*100).toFixed(0)}% ‚Äî NO APROBADO`);
      }
      onSaveUser(data);
    }

    return (
      <div>
        <div className="flex items-center justify-between mb-4">
          <div>
            <h2 className="text-xl font-semibold">Pr√°ctica ‚Äî {level.name}</h2>
            <div className="text-sm muted">Prompt: {queue[index]}</div>
            <div className="text-sm muted">Instrucci√≥n: { (function(){
              // find instruction from vocab file items if exists
              const lessonObj = level.lessons.find(ls=>ls.title===lessonTitle) || level.lessons[0];
              const itemObj = (lessonObj.items || []).find(it => (typeof it==='string'? it : it.palabra) === queue[index]);
              return itemObj && itemObj.instruction ? itemObj.instruction : 'Mostr√° la mano frente a la c√°mara y realiz√° la se√±a.';
            })() }</div>
          </div>
          <div className="flex gap-2">
            <select className="p-2 border rounded" value={level.name} onChange={(e)=>{ localStorage.setItem('gestar_selected_level', e.target.value); location.reload(); }}>
              { levels.map(l=> <option key={l.name} value={l.name}>{l.name}</option>) }
            </select>
            <button className="px-3 py-2 border rounded" onClick={onBack}>Volver</button>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="md:col-span-2">
            <div className="relative bg-black rounded overflow-hidden">
              <video ref={videoRef} className="w-full h-64 object-cover" playsInline muted autoPlay></video>
              <canvas ref={overlayRef} className="overlay"></canvas>
            </div>

            <div className="mt-3 flex gap-2">
              <button className="px-3 py-2 rounded bg-indigo-600 text-white" onClick={()=> cameraOn ? stopCamera() : startCamera()}>{cameraOn ? 'Detener c√°mara' : 'Activar c√°mara'}</button>
              <button className="px-3 py-2 border rounded" onClick={()=> runTestFor(queue[index])} disabled={running}>{running ? 'Test en curso...' : 'Iniciar test'}</button>
              <button className="px-3 py-2 border rounded" onClick={()=>{ const nxt = index+1; if(nxt < queue.length) setIndex(nxt); else alert('Fin de la cola'); }}>Siguiente</button>
            </div>

            <div className="mt-3 p-3 bg-white rounded">
              <div className="flex justify-between items-center">
                <div>
                  <div className="text-sm muted">Prompt actual</div>
                  <div className="text-xl font-bold">{queue[index] || '‚Äî'}</div>
                  <div className="text-xs muted mt-1">Consejo: manten√© la mano centrada y a ~40-60 cm; evita luz fuerte detr√°s.</div>
                </div>
                <div className="text-right">
                  <div className="text-sm">Frames: <strong>{frames}</strong></div>
                  <div className="text-sm">Correctos: <strong>{correct}</strong></div>
                  <div className="text-sm">Precisi√≥n: <strong>{(accuracy*100).toFixed(0)}%</strong></div>
                </div>
              </div>
              <div className="mt-3 text-sm muted">{statusText}</div>
            </div>
          </div>

          <div className="md:col-span-1">
            <div className="p-3 bg-white rounded">
              <h3 className="font-semibold mb-2">Cola</h3>
              <ul className="space-y-1 max-h-72 overflow-auto">
                { queue.map((it,i)=>(
                  <li key={i} className={`p-2 rounded flex justify-between items-center ${i===index ? 'border-l-4 border-indigo-500' : ''}`}>
                    <div>{it}</div>
                    <div><button className="px-2 py-1 border rounded text-xs" onClick={()=>setIndex(i)}>Ir</button></div>
                  </li>
                )) }
              </ul>
              <div className="mt-3 text-sm muted">Si la detecci√≥n falla con buena luz: captur√° varias referencias para este √≠tem en Lecciones ‚Üí Capturar referencia.</div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /******************** Render ********************/
  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
